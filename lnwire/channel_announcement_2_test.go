package lnwire

import (
	"bytes"
	"testing"

	"github.com/stretchr/testify/require"
)

// TestChannelAnnouncement2EncodeDecode asserts that a raw byte stream can be
// decoded, then re-encoded to the same exact byte stream.
func TestChannelAnnouncement2EncodeDecode(t *testing.T) {
	t.Parallel()

	// We'll create a raw byte stream that represents a valid
	// ChannelAnnouncement2 message. This includes the signature and a TLV
	// stream with both known and unknown records.
	rawBytes := []byte{
		// Signature.
		0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8, 0x9, 0xa, 0xb,
		0xc, 0xd, 0xe, 0xf, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16,
		0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
		0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2a,
		0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34,
		0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e,
		0x3f,

		// ChainHash record (optional, not mainnet).
		0x0,  // type.
		0x20, // length.
		0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
		0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,
		0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1, 0x1,

		// Features record.
		0x2,      // type.
		0x2,      // length.
		0x1, 0x2, // value.

		// ShortChannelID record.
		0x4,                                    // type.
		0x8,                                    // length.
		0x0, 0x0, 0x1, 0x0, 0x0, 0x2, 0x0, 0x3, // value.

		// Unknown odd-type TLV record.
		0x5,        // type.
		0x2,        // length.
		0xab, 0xcd, // value.

		// Capacity record.
		0x6,                                      // type.
		0x8,                                      // length.
		0x0, 0x0, 0x0, 0x0, 0x0, 0x1, 0x86, 0xa0, // value: 100000.

		// NodeID1 record.
		0x8,  // type.
		0x21, // length.
		0x2, 0x28, 0xf2, 0xaf, 0xa, 0xbe, 0x32, 0x24, 0x3, 0x48, 0xf,
		0xb3, 0xee, 0x17, 0x2f, 0x7f, 0x16, 0x1, 0xe6, 0x7d, 0x1d, 0xa6,
		0xca, 0xd4, 0xb, 0x54, 0xc4, 0x46, 0x8d, 0x48, 0x23, 0x6c, 0x39,

		// NodeID2 record.
		0xa,  // type.
		0x21, // length.
		0x3, 0x28, 0xf2, 0xaf, 0xa, 0xbe, 0x32, 0x24, 0x3, 0x48, 0xf,
		0xb3, 0xee, 0x17, 0x2f, 0x7f, 0x16, 0x1, 0xe6, 0x7d, 0x1d, 0xa6,
		0xca, 0xd4, 0xb, 0x54, 0xc4, 0x46, 0x8d, 0x48, 0x23, 0x6c, 0x39,

		// Extra Opaque Data - Unknown Record.
		0x6f,       // type.
		0x2,        // length.
		0x79, 0x79, // value.
	}

	// Now, create a new empty message and decode the raw bytes into it.
	msg := &ChannelAnnouncement2{}
	r := bytes.NewReader(rawBytes)
	err := msg.Decode(r, 0)
	require.NoError(t, err)

	// Next, encode the message back into a new byte buffer.
	var b bytes.Buffer
	err = msg.Encode(&b, 0)
	require.NoError(t, err)

	// The re-encoded bytes should be exactly the same as the original raw
	// bytes.
	require.Equal(t, rawBytes, b.Bytes())
}
